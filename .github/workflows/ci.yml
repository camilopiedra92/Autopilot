# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# GitHub Actions CI/CD â€” Bankâ†’YNAB v4.0
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
# Jobs:
#   1. lint    â€” ruff linting + format check
#   2. test    â€” pytest unit tests (no API keys)
#   3. build   â€” Docker image build + push to Artifact Registry
#   4. deploy  â€” Cloud Run deploy (main branch only)
#
# Required GitHub Secrets:
#   - WIF_PROVIDER:          Workload Identity Federation provider
#   - WIF_SERVICE_ACCOUNT:   Service account for WIF
#   - GCP_PROJECT_ID:        Google Cloud project ID
#
# Required Secret Manager secrets (in GCP):
#   - google-api-key:        Gemini API key
#   - ynab-access-token:     YNAB personal access token
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

name: CI/CD Pipeline

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master]
  workflow_dispatch:

env:
  PYTHON_VERSION: "3.13"
  REGISTRY: us-central1-docker.pkg.dev
  SERVICE_NAME: bank-to-ynab
  REGION: us-central1

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

jobs:
  # â”€â”€ Job 1: Lint â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  lint:
    name: ðŸ§¹ Lint & Format
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install ruff
        run: pip install ruff

      - name: Ruff lint
        run: ruff check . --output-format=github

      - name: Ruff format check
        run: ruff format --check .

  # â”€â”€ Job 2: Test â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  test:
    name: ðŸ§ª Unit Tests
    runs-on: ubuntu-latest
    needs: [lint]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: pip

      - name: Install dependencies
        run: pip install '.[dev]'

      - name: Run tests
        env:
          # Dummy values â€” tests don't call real APIs
          GOOGLE_API_KEY: test-key-not-real
          GOOGLE_GENAI_API_KEY: test-key-not-real
          YNAB_ACCESS_TOKEN: test-token-not-real
          TELEGRAM_BOT_TOKEN: test-token-not-real
        run: |
          python -m pytest tests/ workflows/*/tests/ \
            -v --tb=short -x \
            -k "not integration and not real_email" \
            --junitxml=test-results.xml \
            --cov=autopilot --cov=workflows --cov-report=xml:coverage.xml \
            --cov-report=term-missing

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results
          path: test-results.xml

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage
          path: coverage.xml

  # â”€â”€ Job 3: Build & Push Docker image â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  build:
    name: ðŸ³ Build & Push
    runs-on: ubuntu-latest
    needs: [test]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGISTRY }} --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Derive version from git tags
        id: version
        run: |
          pip install setuptools-scm
          echo "VERSION=$(python -m setuptools_scm)" >> "$GITHUB_OUTPUT"

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          build-args: |
            SETUPTOOLS_SCM_PRETEND_VERSION=${{ steps.version.outputs.VERSION }}
          tags: |
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
            ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # â”€â”€ Job 4: Deploy to Cloud Run â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  deploy:
    name: ðŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    permissions:
      contents: read
      id-token: write
    environment: production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ env.SERVICE_NAME }}
          region: ${{ env.REGION }}
          image: ${{ env.REGISTRY }}/${{ secrets.GCP_PROJECT_ID }}/${{ env.SERVICE_NAME }}/${{ env.SERVICE_NAME }}:${{ github.sha }}
          flags: |
            --memory=512Mi
            --cpu=1
            --min-instances=0
            --max-instances=5
            --concurrency=80
            --timeout=120s
            --cpu-boost
            --set-env-vars=PYTHONUNBUFFERED=1,GOOGLE_CLOUD_PROJECT=antigravity-bank-ynab,GCP_PUBSUB_TOPIC=projects/antigravity-bank-ynab/topics/gmail-notifications,EVENTBUS_BACKEND=pubsub,SESSION_BACKEND=firestore,MEMORY_BACKEND=firestore,ARTIFACT_BACKEND=gcs,ARTIFACT_GCS_BUCKET=antigravity-bank-ynab-artifacts,MODEL_RATE_LIMIT_QPM=1500,CONTEXT_CACHE_MIN_TOKENS=2048,CONTEXT_CACHE_TTL_SECONDS=1800,CONTEXT_CACHE_INTERVALS=10,CONTEXT_COMPRESSION_TRIGGER_TOKENS=100000,CONTEXT_COMPRESSION_TARGET_TOKENS=80000
            --set-secrets=GOOGLE_API_KEY=google-api-key:latest,YNAB_ACCESS_TOKEN=ynab-access-token:latest,API_KEY_SECRET=api-key-secret:latest,TODOIST_API_TOKEN=todoist-api-token:latest,AIRTABLE_PERSONAL_ACCESS_TOKEN=airtable-personal-access-token:latest,TELEGRAM_BOT_TOKEN=telegram-bot-token:latest,/secrets/credentials/credentials.json=gmail-credentials:latest,/secrets/token/token.json=gmail-token:latest

      - name: Smoke test deployed service
        run: |
          URL=$(gcloud run services describe ${{ env.SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "ðŸ”— Service URL: $URL"
          STATUS=$(curl -sf "$URL/health" | python -m json.tool)
          echo "$STATUS"
          echo "$STATUS" | grep -q '"status": "healthy"' || exit 1
          echo "âœ… Smoke test passed"
