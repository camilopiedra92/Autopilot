# ðŸ—ï¸ Autopilot Platform â€” World-Class Architecture Audit

> **Scope**: Full deep-dive of the Autopilot codebase â€” every module, connector, test, tool, CI/CD pipeline, and Dockerfile â€” evaluated against [ARCHITECTURE.md](file:///Users/camilopiedra/Development/Autopilot/docs/ARCHITECTURE.md) and Google ADK latest standards.

---

## Executive Summary

The platform has **exceptionally strong architectural foundations** â€” factory agents, typed BaseAgent contract, DAG/ReAct/Router orchestration, declarative DSL, tool ecosystem with lifecycle callbacks, session/memory abstraction, structured error taxonomy, and A2A bus. This is already far ahead of most agentic platforms.

However, the audit found **21 specific items** across three categories:

| Category                                           | Count | Impact                |
| -------------------------------------------------- | ----- | --------------------- |
| ðŸ—‘ï¸ **ELIMINATE** (tech debt, junk, duplicates)     | 8     | Immediate cleanup     |
| ðŸ”§ **ADJUST** (misalignments, suboptimal patterns) | 7     | Edge â†’ World-Class    |
| âœ¨ **ADD** (missing world-class capabilities)      | 6     | Competitive advantage |

---

## ðŸ—‘ï¸ ELIMINATE â€” Remove Immediately

### âœ… E1. Root-Level Orphan Scripts (8 files) â€” DONE

> [!CAUTION]
> **8 debugging scripts** scattered at the project root violate the "no legacy code path" rule (ARCHITECTURE.md Â§9.4).

| File                                                                                              | Purpose            | Action |
| ------------------------------------------------------------------------------------------------- | ------------------ | ------ |
| [check_email_labels.py](file:///Users/camilopiedra/Development/Autopilot/check_email_labels.py)   | Debug Gmail labels | DELETE |
| [check_email_labels2.py](file:///Users/camilopiedra/Development/Autopilot/check_email_labels2.py) | Dupe of above      | DELETE |
| [check_email_time.py](file:///Users/camilopiedra/Development/Autopilot/check_email_time.py)       | Debug time         | DELETE |
| [check_gmail.py](file:///Users/camilopiedra/Development/Autopilot/check_gmail.py)                 | Debug Gmail        | DELETE |
| [check_gmail2.py](file:///Users/camilopiedra/Development/Autopilot/check_gmail2.py)               | Dupe of above      | DELETE |
| [check_history_id.py](file:///Users/camilopiedra/Development/Autopilot/check_history_id.py)       | Debug history      | DELETE |
| [stop_watch.py](file:///Users/camilopiedra/Development/Autopilot/stop_watch.py)                   | Stop Gmail watch   | DELETE |
| [test_func.py](file:///Users/camilopiedra/Development/Autopilot/test_func.py)                     | Test scratch       | DELETE |

Also delete auxiliary files:

- [test_real_world.py](file:///Users/camilopiedra/Development/Autopilot/test_real_world.py) â€” scratch test
- [test_union.py](file:///Users/camilopiedra/Development/Autopilot/test_union.py) â€” scratch test
- [deploy_test.sh](file:///Users/camilopiedra/Development/Autopilot/deploy_test.sh) â€” one-off deploy script
- [cr_spec.json](file:///Users/camilopiedra/Development/Autopilot/cr_spec.json) â€” Cloud Run spec dump

**Impact**: Cleaner root, no accidental docker image bloat (even with `.dockerignore`).

> [!NOTE]
> **COMPLETED** â€” All 12 root-level orphan scripts deleted.

---

### âœ… E2. Duplicate Event Bus â€” `PipelineEventBus` vs `AgentBus` â€” DONE

> [!WARNING]
> Two separate pub/sub systems exist, violating the single-bus architecture principle.

| Component          | Location                                                                                         | Purpose                             |
| ------------------ | ------------------------------------------------------------------------------------------------ | ----------------------------------- |
| `PipelineEventBus` | [event_bus.py](file:///Users/camilopiedra/Development/Autopilot/autopilot/services/event_bus.py) | `asyncio.Queue`-based SSE streaming |
| `AgentBus`         | [bus.py](file:///Users/camilopiedra/Development/Autopilot/autopilot/core/bus.py)                 | Typed A2A pub/sub messaging         |

**Problem**: `AgentContext.__post_init__` imports from `autopilot.services.event_bus` (PipelineEventBus) for SSE, while also exposing `AgentBus` for agent communication. Two buses = split observability, duplicate concepts, confusing API surface.

**Recommendation**: Merge `PipelineEventBus` into `AgentBus` as a **topic namespace** (e.g., `pipeline.step_started`, `pipeline.step_completed`). SSE streams should subscribe to `pipeline.*` topics on the `AgentBus`. Eliminate `autopilot/services/event_bus.py` entirely.

> [!NOTE]
> **COMPLETED** â€” Unified `EventBus` with `EventBusProtocol` ABC, middleware chain, and `replay()`. All 30+ `ctx.emit()` callsites migrated to `ctx.publish()`. `PipelineEventBus` deleted. 321 tests passing.

---

### âœ… E3. Legacy `requirements.txt` â€” DONE

The project uses [pyproject.toml](file:///Users/camilopiedra/Development/Autopilot/pyproject.toml) for dependencies but also maintained a `requirements.txt`. The Dockerfile uses `pip install .` (pyproject.toml). The `requirements.txt` was orphaned dead code â€” zero consumers (not used by Docker, CI, or local dev) and out of sync (missing 5 deps).

**Action**: DELETE `requirements.txt`.

> [!NOTE]
> **COMPLETED** â€” `requirements.txt` deleted. `pyproject.toml` is the single source of truth for all dependency management (PEP 621).

---

### âœ… E4. `credentials.json` + `token.json` at Root â€” DONE

> [!CAUTION]
> **Security risk**: OAuth credentials committed to the repo root.

| File                                                                                  | Risk                                    |
| ------------------------------------------------------------------------------------- | --------------------------------------- |
| [credentials.json](file:///Users/camilopiedra/Development/Autopilot/credentials.json) | OAuth client secret â€” **NEVER** in repo |
| [token.json](file:///Users/camilopiedra/Development/Autopilot/token.json)             | OAuth refresh token â€” **NEVER** in repo |

**Action**: Add to `.gitignore` immediately (if not already). Verify these are NOT in git history. If they are, rotate credentials and scrub with `git filter-repo`.

> [!NOTE]
> **COMPLETED** â€” Both files already in `.gitignore` (lines 19-20). Verified NOT tracked and NEVER committed to git history.

---

### âœ… E5. `autopilot/services/` Directory â€” Nearly Empty â€” DONE

The entire `autopilot/services/` directory contains only 2 files:

- `__init__.py` (57 bytes)
- `event_bus.py` (to be merged into `AgentBus` per E2)

**Action**: After E2, delete the entire `autopilot/services/` directory.

> [!NOTE]
> **COMPLETED** â€” Entire `autopilot/services/` directory deleted as part of E2.

---

### âœ… E6. `autopilot/auth/` Directory â€” Consolidated â€” DONE

`autopilot/auth/` contained only `api_security.py` (FastAPI `X-API-Key` header validation). This is **NOT** a duplicate of `core/tools/auth.py` (tool-level credential management) â€” they serve different architectural layers. The file was relocated to its natural home: `autopilot/api/security.py` (alongside `middleware.py`, `errors.py`). The orphan directory was deleted.

**Also fixed**: API key comparison hardened from `!=` (timing-attack vulnerable) to `hmac.compare_digest()` (constant-time).

> [!NOTE]
> **COMPLETED** â€” `api_security.py` â†’ `autopilot/api/security.py`. Import in `routes.py` updated. `autopilot/auth/` deleted. `hmac.compare_digest` applied. All tests pass.

---

### âœ… E7. Hardcoded `service_name` in Observability â€” DONE

In [observability.py](file:///Users/camilopiedra/Development/Autopilot/autopilot/observability.py#L34), the default service name was hardcoded as `"bank-to-ynab"`:

```python
def setup_tracing(service_name: str = "bank-to-ynab", ...):
```

This was a **workflow-specific value** in a **platform-level module**. Should default to `"autopilot"` or read from `APP_NAME`.

> [!NOTE]
> **COMPLETED** â€” Default `service_name` now resolves from `K_SERVICE` env var (Cloud Run) or `APP_NAME.lower()`. Also added Cloud Trace exporter (A4) as 3-tier hierarchy: OTLP â†’ Cloud Trace â†’ Console. 6 unit tests added.

---

### âœ… E8. `autopilot/agents/pipeline_runner.py` â€” Consolidated as `ADKRunner` â€” DONE

[pipeline_runner.py](file:///Users/camilopiedra/Development/Autopilot/autopilot/agents/pipeline_runner.py) was **NOT legacy** â€” it is the ADK Runtime Bridge, the ONLY way to execute native Google ADK agents (`LlmAgent`, `SequentialAgent`, etc.) via `google.adk.runners.Runner`. `ADKAgent.run()` depends on it. The problem was naming ("PipelineRunner" confused with `Pipeline`) and location (`agents/` instead of `core/`).

**Resolution**: Renamed to `ADKRunner`, relocated to `autopilot/core/adk_runner.py`, deleted old file, updated all imports. Zero backward-compat code.

> [!NOTE]
> **COMPLETED** â€” `PipelineRunner` â†’ `ADKRunner` in `autopilot/core/adk_runner.py`. All imports migrated, old file deleted, docstrings updated, ARCHITECTURE.md updated.

---

## ðŸ”§ ADJUST â€” Upgrade to World-Class

### âœ… A1. Session Service â€” Aligned with ADK's Native `SessionService` â€” DONE

Google ADK's native `SessionService` uses `Session` objects with `id`, `app_name`, `user_id`, `state`, and `events`. The platform's old `BaseSessionService` was a simpler KV store.

**Resolution**: Eliminated the custom ABC entirely. `session.py` is now 23 lines of pure ADK re-exports. `ctx.session` is the ADK `Session` directly â€” `ctx.session.state` is a plain dict. Deleted `RedisSessionService` and `SessionStateAccessor`. 335 tests pass.

> [!NOTE]
> **COMPLETED** â€” Platform session layer fully aligned with Google ADK. No custom abstractions remain.

---

### âœ… A2. Memory Service â€” ADK-Native Alignment â€” DONE

Eliminated all custom memory abstractions (389 lines â†’ 90 lines of ADK re-exports). Replaced `Observation`, custom `BaseMemoryService`, TF-IDF `InMemoryMemoryService`, and `ChromaMemoryService` with pure ADK re-exports + `create_memory_service()` factory. Removed `chromadb` dependency (~200MB savings).

**Files changed:**

- `autopilot/core/memory.py` â€” Replaced 389 lines with ADK re-exports + 12-Factor factory
- `autopilot/core/context.py` â€” `remember()` â†’ `add_events_to_memory()`, `recall()` â†’ `search_memory()`
- `autopilot/core/adk_runner.py` â€” Critical fix: passes `memory_service` to ADK `Runner`
- `autopilot/core/__init__.py` â€” Replaced `Observation` with `MemoryEntry`, `SearchMemoryResponse`, `create_memory_service`
- `pyproject.toml` â€” Removed `chromadb>=0.4.0`
- `.env.example` â€” Added `MEMORY_BACKEND`, `MEMORY_AGENT_ENGINE_ID` docs
- `Dockerfile` â€” Added `MEMORY_BACKEND`, `MEMORY_AGENT_ENGINE_ID` to env docs
- `docs/ARCHITECTURE.md` â€” Updated memory section with backend selection table & ADK types
- `tests/autopilot/test_core.py` â€” Rewrote all memory tests (14 tests, ADK-native API)

**Deploy:** `MEMORY_BACKEND` defaults to `memory` locally/CI. Production sets `vertexai` via `--set-env-vars MEMORY_BACKEND=vertexai,MEMORY_AGENT_ENGINE_ID=<id>`. 443 total tests passing.

---

### âœ… A3. AgentBus â€” Cloud-Native Pub/Sub Backend â€” DONE

Implemented `CloudPubSubEventBus` (`autopilot/core/bus_pubsub.py`) backed by Google Cloud Pub/Sub with hybrid dispatch (local zero-latency + Pub/Sub persistence/cross-instance). Added `create_event_bus()` factory with `EVENTBUS_BACKEND` env var selection and startup logging (`event_bus_backend_selected`). In-memory `EventBus` remains for dev/test (12-Factor best practice).

**Files changed:**

- `autopilot/core/bus_pubsub.py` â€” NEW: `CloudPubSubEventBus(EventBusProtocol)`
- `autopilot/core/bus.py` â€” `create_event_bus()` factory, `get_event_bus()` â†’ `EventBusProtocol`, cleaned `RedisStreamEventBus` dead ref
- `autopilot/core/__init__.py` â€” exports `create_event_bus`
- `pyproject.toml` â€” `google-cloud-pubsub>=2.20.0`
- `tests/autopilot/test_bus_pubsub.py` â€” NEW: 24 tests (all Pub/Sub mocked)
- `.env.example` â€” documented `EVENTBUS_BACKEND`
- `Dockerfile` â€” documented `EVENTBUS_BACKEND` in env vars section

**Deploy:** `EVENTBUS_BACKEND` defaults to `memory` locally/CI. Production sets `pubsub` explicitly via `--set-env-vars EVENTBUS_BACKEND=pubsub` at deploy time. 24 new tests, 359 total passing.

---

### âœ… A4. Observability â€” Cloud Trace Integration â€” DONE

[observability.py](file:///Users/camilopiedra/Development/Autopilot/autopilot/observability.py) has OpenTelemetry + Prometheus, but the OTel exporter only supported OTLP or Console. On Cloud Run, you should use **Cloud Trace** directly.

**Recommendation**: Add `opentelemetry-exporter-gcp-trace` as the production exporter:

```python
if os.getenv("K_SERVICE"):  # Running on Cloud Run
    from opentelemetry.exporter.cloud_trace import CloudTraceSpanExporter
    exporter = CloudTraceSpanExporter()
```

> [!NOTE]
> **COMPLETED** â€” Implemented as part of E7. 3-tier exporter hierarchy: OTLP â†’ Cloud Trace â†’ Console. Zero-config on Cloud Run.

---

### âœ… A5. Dockerfile â€” Multi-Stage Leak & Worker Fix â€” DONE

The Dockerfile had two issues:

1. **`COPY . .` in runtime stage** â€” copied everything into the final image, relying solely on `.dockerignore` (denylist). Replaced with **explicit allowlist COPYs**: `app.py`, `autopilot/`, `workflows/`. Secrets, docs, scripts, configs excluded by omission.

2. **`--workers 2` hardcoded** â€” Cloud Run deploys with `--cpu=1`. Multiple Uvicorn workers waste memory with zero CPU parallelism (GIL) for this I/O-bound async app. Removed `--workers 2`, defaulting to 1 worker. Tunable via `WEB_CONCURRENCY` env var (Uvicorn native).

Also hardened `.dockerignore` with `docs/`, `scripts/`, `*.egg-info/`, `ruff.toml`, `.env.example` as belt-and-suspenders.

> [!NOTE]
> **COMPLETED** â€” Explicit COPY allowlist in Dockerfile. `--workers 2` â†’ single worker (Cloud Run optimal). `.dockerignore` hardened.

---

### âœ… A6. CORS Wildcard in Production â€” DONE

```python
cors_origins_str = os.getenv("API_CORS_ORIGINS", "")
```

Default changed from `"*"` to `""` â€” CORS is now **disabled by default** (headless API). `CORSMiddleware` is only mounted when `API_CORS_ORIGINS` is explicitly set. Opt-in via env var (e.g., `API_CORS_ORIGINS=https://admin.example.com`).

> [!NOTE]
> **COMPLETED** â€” Default `""`, conditional middleware mount, `.env.example` documented, 5 unit tests added. 332 tests passing.

---

### A7. Version String â€” `"5.0.0"` But No Changelog

The app claims `v5.0.0` but there's no `CHANGELOG.md` or release strategy. For a world-class platform, version should be auto-derived from git tags.

**Recommendation**: Use `setuptools-scm` or `hatch-vcs` to auto-derive version from git tags. Eliminates manual `version.py` edits.

---

## âœ¨ ADD â€” World-Class Missing Capabilities

### âœ… N1. A2A Protocol Server Implementation â€” DONE

ARCHITECTURE.md references A2A (Agent-to-Agent) Protocol extensively via manifests and agent cards, but there was **no A2A server endpoint**. The platform couldn't be discovered or invoked by external agents.

**Implemented**: Using the official `a2a-sdk` (Google's A2A Python SDK), the platform now exposes:

- `GET /.well-known/agent-card.json` â€” agent card discovery (unauthenticated, A2A spec)
- `POST /a2a` â€” JSON-RPC endpoint (`message/send`, `message/stream`, `tasks/get`)
- Each registered workflow is exposed as an A2A Skill
- Task lifecycle: `submitted â†’ working â†’ completed`

**Files**: `autopilot/api/a2a/` (4 files), `tests/test_a2a.py` (23 tests)

> [!NOTE]
> **COMPLETED** â€” Full A2A Protocol server with agent card discovery and JSON-RPC task endpoint. All workflows auto-exposed as A2A Skills.

---

### âœ… N2. Structured Output Enforcement (Gemini Native) â€” DONE

ADK natively handles `output_schema` â†’ `response_schema` + `response_mime_type=application/json`. Removed dead function_call extraction code from `adk_runner.py`, tightened `ADKAgent.run()` with Pydantic re-validation, added agent isolation flags in `create_platform_agent`. 4 new tests, 386 total pass.

> [!NOTE]
> **COMPLETED** â€” Leveraged ADK native structured output. Dead code removed, Pydantic re-validation added, agent isolation flags set.

---

### âœ… N3. Gemini Context Caching (Cost Optimization) â€” DONE

Implemented per-agent context caching using ADK's native `ContextCacheConfig`. Agents opt in via `create_platform_agent(cache_context=True)`. When enabled, `ADKRunner` wraps the agent in `App(context_cache_config=...)` so ADK caches system instructions + tool schemas server-side (up to 75% cost reduction). Non-cached agents use the standard `Runner` path â€” zero behavior change.

**Files:**

- `autopilot/agents/context_cache.py` â€” NEW: `create_context_cache_config()` factory, `has_cache_context()`, `PLATFORM_CACHE_CONTEXT_ATTR`
- `autopilot/agents/base.py` â€” `cache_context` param in `create_platform_agent`
- `autopilot/core/adk_runner.py` â€” Conditional `App` wrapper for cache-enabled agents
- `tests/autopilot/test_context_cache.py` â€” NEW: 12 tests
- `.env.example`, `Dockerfile`, `ARCHITECTURE.md` â€” documented env vars

**Config (12-Factor):** `CONTEXT_CACHE_MIN_TOKENS` (2048), `CONTEXT_CACHE_TTL_SECONDS` (1800), `CONTEXT_CACHE_INTERVALS` (10).

> [!NOTE]
> **COMPLETED** â€” Per-agent context caching with ADK-native `ContextCacheConfig`. 442 tests passing.

---

### âœ… N4. Firestore-Backed Session Service (Serverless) â€” DONE

Implemented `FirestoreSessionService` as an ADK-native `BaseSessionService` backend. Full implementation:

- **`autopilot/core/session_firestore.py`** â€” `FirestoreSessionService(BaseSessionService)` with CRUD, transactional `append_event`, app/user/session state deltas, `from_env()` classmethod.
- **`autopilot/core/session.py`** â€” `create_session_service()` factory (12-Factor: `SESSION_BACKEND` env var, default `memory`, production `firestore`).
- **`autopilot/core/context.py`** â€” `AgentContext` uses factory instead of hardcoded `InMemorySessionService`.
- **Deploy config** â€” `SESSION_BACKEND=firestore` added to `ci.yml` and `deploy_to_cloud_run.md`.
- **GCP provisioned** â€” Firestore API enabled, Native mode database created in `us-central1` (free tier). Single `(default)` database serves all workflows via `app_name` partitioning.
- **Tests** â€” 19 unit tests with fully mocked Firestore (zero external deps).

---

### N5. Artifact Store for Pipeline Runs âœ… DONE

ADK-native versioned artifact storage with 12-Factor factory. Enables cross-run debugging, audit trails, and replay:

- **Backends**: `InMemoryArtifactService` (dev/test) / `GcsArtifactService` (production via `ARTIFACT_BACKEND=gcs`)
- **Context methods**: `ctx.save_artifact()`, `ctx.load_artifact(run_id=)`, `ctx.list_artifacts()`
- **ADK-native types**: `types.Part` only â€” zero custom wrapping

Files: `autopilot/core/artifact.py` (new), `autopilot/core/context.py`, `autopilot/core/adk_runner.py`, `autopilot/core/__init__.py`, `autopilot/errors.py` (`ArtifactServiceError`), `ARCHITECTURE.md` updated.

---

### N6. Platform-Level Rate Limiting on LLM Calls âœ… DONE

Dual-layer rate limiting, fully aligned with Google ADK:

- **Layer 1 (Reactive)**: ADK-native `HttpRetryOptions` injected into `GenerateContentConfig` â€” auto-retries transient 429s. Always-on.
- **Layer 2 (Proactive)**: Token-bucket `ModelRateLimiter` via `before_model_callback` â€” prevents 429s by throttling QPM locally. Opt-in via `MODEL_RATE_LIMIT_QPM` env var.

Files: `autopilot/agents/rate_limiter.py` (new), `autopilot/agents/base.py`, `autopilot/errors.py` (`ModelRateLimitError`), `ARCHITECTURE.md` updated.

---

## Summary of Priorities

### Immediate (Day 1) â€” Zero Cost, Massive Cleanup

| #   | Action                         | Type    | Effort |
| --- | ------------------------------ | ------- | ------ |
| E1  | ~~Delete 12 root junk files~~  | âœ… DONE | â€”      |
| E3  | ~~Delete `requirements.txt`~~  | âœ… DONE | â€”      |
| E4  | ~~Secure credentials~~         | âœ… DONE | â€”      |
| E7  | ~~Fix hardcoded service name~~ | âœ… DONE | â€”      |
| A6  | ~~Fix CORS default~~           | âœ… DONE | â€”      |

### Short-Term (Week 1) â€” Architectural Hygiene

| #   | Action                                   | Type    | Effort |
| --- | ---------------------------------------- | ------- | ------ |
| E2  | ~~Merge PipelineEventBus into AgentBus~~ | âœ… DONE | â€”      |
| E5  | ~~Delete `autopilot/services/`~~         | âœ… DONE | â€”      |
| E6  | ~~Consolidate auth~~                     | âœ… DONE | â€”      |
| E8  | ~~Consolidate pipeline_runner~~          | âœ… DONE | â€”      |
| A4  | ~~Add Cloud Trace exporter~~             | âœ… DONE | â€”      |
| A5  | ~~Fix Dockerfile COPY~~                  | âœ… DONE | â€”      |

### Medium-Term (Month 1) â€” Edge Differentiation

| #   | Action                                      | Type    | Effort |
| --- | ------------------------------------------- | ------- | ------ |
| A1  | ~~Align session with ADK SessionService~~   | âœ… DONE | â€”      |
| A3  | ~~Cloud-native AgentBus (Pub/Sub backend)~~ | âœ… DONE | â€”      |
| N1  | ~~A2A Protocol server~~                     | âœ… DONE | â€”      |
| N2  | ~~Structured output enforcement~~           | âœ… DONE | â€”      |
| N4  | ~~FirestoreSessionService (ADK ABC impl)~~  | âœ… DONE | â€”      |
| N6  | ~~Model rate limiter~~                      | âœ… DONE | â€”      |

### Long-Term (Quarter) â€” World-Class Edge

| #   | Action                        | Type    | Effort |
| --- | ----------------------------- | ------- | ------ |
| A2  | ~~ADK-native Memory Service~~ | âœ… DONE | â€”      |
| N3  | ~~Gemini context caching~~    | âœ… DONE | â€”      |
| N5  | ~~Artifact Store~~            | âœ… DONE | â€”      |
| A7  | Auto-version from git tags    | ADJUST  | 1h     |
